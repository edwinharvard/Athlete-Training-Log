{% extends "layout.html" %}

{% block title %}Your Training Calendar{% endblock %}

{% block main %}
<div class="container-fluid px-5 mt-4">
  <h1 class="text-center mb-3">Welcome, {{ user.username|capitalize }}</h1>

  <!-- Athlete Summary -->
  <div class="d-flex justify-content-center mb-5">
    <span class="me-4"><strong>Graduation Year:</strong> {{ user.graduation_year }}</span>
    <span><strong>Planned Hours:</strong> {{ user.planned_hours }}</span>
  </div>

  <!-- Action Cards Row 1 -->
  <div class="row g-4 mb-5">
    <div class="col-12 col-md-6">
      <div class="card h-100 shadow-sm">
        <div class="card-body d-flex flex-column">
          <h5 class="card-title">Add Workout</h5>
          <p class="card-text flex-grow-1">Log a new workout to track your progress.</p>
          <a href="/add-workout" class="btn btn-primary mt-auto">Add Workout</a>
        </div>
      </div>
    </div>
    <div class="col-12 col-md-6">
      <div class="card h-100 shadow-sm">
        <div class="card-body d-flex flex-column">
          <h5 class="card-title">View Training Log</h5>
          <p class="card-text flex-grow-1">See all your past workouts in one place.</p>
          <a href="/athlete" class="btn btn-secondary mt-auto">View Log</a>
        </div>
      </div>
    </div>
  </div>

  <!-- Action Cards Row 2: Race -->
  <div class="row g-4 mb-5">
    <div class="col-12 col-md-6">
      <div class="card h-100 shadow-sm">
        <div class="card-body d-flex flex-column">
          <h5 class="card-title">Add Race</h5>
          <p class="card-text flex-grow-1">Record an upcoming or past race and set your goals.</p>
          <a href="/add-race" class="btn btn-danger mt-auto">Add Race</a>
        </div>
      </div>
    </div>
  </div>

  <!-- Aggregate Data -->
  <div class="card mb-5 shadow-sm">
    <div class="card-body">
      <h5 class="card-title mb-3">Aggregate Training Data</h5>
      <p class="mb-2"><strong>Year-to-Date Hours:</strong> {{ workout.total_hours|round(2) }}</p>

      {% if user.planned_hours|int > 0 %}
        {% set percent = ((workout.total_hours|round(2) / user.planned_hours|int) * 100)|round(0, 'floor') %}
        <div class="mb-4">
          <label class="form-label fw-semibold">Training Year Progress</label>
          <div class="progress" style="height: 1.5rem;">
            <div class="progress-bar bg-dark" role="progressbar"
                 style="width: {{ percent }}%;"
                 aria-valuenow="{{ percent }}" aria-valuemin="0" aria-valuemax="100">
              {{ percent }}%
            </div>
          </div>
        </div>
      {% endif %}

      <div class="chart-container mb-4" style="max-width: 400px; margin: auto;">
        <canvas id="workoutPieChart" style="width: 100%; height: 200px;"></canvas>
      </div>
    </div>
  </div>

  <!-- 7-Day Calendar -->
  <h3 class="mb-3">Last 7 Days of Training</h3>
  <div class="table-responsive mb-5">
    <table class="table table-bordered text-center">
      <thead class="table-light">
        <tr>
          {% for d in week_dates %}
            <th class="p-3">{{ d.strftime("%a %b %d") }}</th>
          {% endfor %}
        </tr>
      </thead>
      <tbody>
        <tr>
          {% for d in week_dates %}
            <td class="align-top p-3">
              {% if workouts_by_date[d] %}
                <ul class="list-unstyled mb-0">
                  {% for w in workouts_by_date[d] %}
                    <li><strong>{{ w.completed_hours|round(2) }}h</strong> – {{ w.workout_type }}</li>
                  {% endfor %}
                </ul>
              {% else %}
                <span class="text-muted">—</span>
              {% endif %}
            </td>
          {% endfor %}
        </tr>
      </tbody>
    </table>
  </div>
  <div class="row mb-5">
    <div class="col-12 col-md-8 offset-md-2">
      <div class="card shadow-sm">
        <div class="card-header bg-secondary text-white">
          <h5 class="mb-0">Upcoming Races</h5>
        </div>
        <div class="card-body">
          {% if upcoming_races %}
            <ul class="list-group list-group-flush">
              {% for race in upcoming_races %}
                <li class="list-group-item">
                  <strong>{{ race.race_name }}</strong> &mdash; {{ race.race_date }}
                </li>
              {% endfor %}
            </ul>
          {% else %}
            <p class="text-muted mb-0">No upcoming races.</p>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- Strava Connect/Sync -->
  <div class="text-center mb-5">
    {% if not strava_connected %}
      <a href="{{ url_for('strava_auth') }}" class="btn btn-primary">Connect with Strava</a>
    {% else %}
      <a href="{{ url_for('fetch_activities') }}" class="btn btn-success">Sync Strava Activities</a>
    {% endif %}
  </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const labels = {{ workout.types | tojson }};
  const dataValues = {{ workout.hours_by_type | tojson }};

  const ctx = document.getElementById('workoutPieChart').getContext('2d');
  new Chart(ctx, {
    type: 'pie',
    data: {
      labels,
      datasets: [{
        data: dataValues,
        backgroundColor: labels.map((_, i) => `hsl(${i * (360 / labels.length)}, 70%, 50%)`)
      }]
    },
    options: {
      responsive: true,
      plugins: { legend: { position: 'bottom' },
      tooltip: {
        callbacks: {
          label: function(context) {
            const value = context.raw.toFixed(2);
            return `${context.label}: ${value} hours`;
          }
        }
      }
     }
    }
  });
</script>
{% endblock %}
